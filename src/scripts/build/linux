#!/bin/bash

mozbuild=~/.mozbuild
export PATH="$PATH:$mozbuild/git-cinnabar"
rootDir=$PWD

if [ ! -d $mozbuild ]; then
  mkdir $mozbuild
fi

if [ ! -d mozilla-unified ]; then
	if command -v aria2c &> /dev/null; then
		downloader=aria2c
	else
		downloader=curl
	fi

	$downloader https://hg.mozilla.org/releases/mozilla-release/archive/tip.zip -o mozilla-unified.zip
	unzip mozilla-unified.zip -d unzipped-mozilla-unified
	mv unzipped-mozilla-unified/* mozilla-unified
fi

cd mozilla-unified

./mach bootstrap

cp -r ../src/changed/* .
cp ../src/mozconfig.linux mozconfig
patch -N -p1 < ../src/mozilla_dirsFromLibreWolf.patch

./mach configure
./mach build
./mach package

cd ..

mkdir NEUTRON_INTERNAL_APP_NAME
tar --strip-components=1 -xvf  mozilla-unified/obj-x86_64-pc-linux-gnu/dist/*.tar.bz2 -C NEUTRON_INTERNAL_APP_NAME/
cp -r src/distribution/ NEUTRON_INTERNAL_APP_NAME/
mv NEUTRON_INTERNAL_APP_NAME/distribution/policies-linux.json NEUTRON_INTERNAL_APP_NAME/distribution/policies.json
cp src/open-in-default-browser/open-in-default-browser NEUTRON_INTERNAL_APP_NAME/open-in-default-browser
cp src/launch-app.linux NEUTRON_INTERNAL_APP_NAME/launch-app
cp src/open-in-default-browser/open_in_default_browser-1.0.zip NEUTRON_INTERNAL_APP_NAME/open_in_default_browser-1.0.zip
tar -cjf NEUTRON_INTERNAL_APP_NAME.tar.bz2 NEUTRON_INTERNAL_APP_NAME 
